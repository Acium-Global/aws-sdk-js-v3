"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseOutpostArnablesMiddleawareOptions = exports.parseOutpostArnablesMiddleaware = void 0;
const middleware_bucket_endpoint_1 = require("@aws-sdk/middleware-bucket-endpoint");
const util_arn_parser_1 = require("@aws-sdk/util-arn-parser");
const constants_1 = require("../constants");
/**
 * Validate input `Name` or `Bucket` parameter is acceptable ARN format. If so, modify the input ARN to inferred
 * resource identifier, notify later middleware to redirect request to Outpost endpoint, signing service and signing
 * region.
 */
const parseOutpostArnablesMiddleaware = (options) => (next, context) => async (args) => {
    const { input } = args;
    const parameter = input.Name && util_arn_parser_1.validate(input.Name) ? "Name" : input.Bucket && util_arn_parser_1.validate(input.Bucket) ? "Bucket" : undefined;
    if (!parameter)
        return next(args);
    const clientRegion = await options.region();
    const { regionInfoProvider } = options;
    const useArnRegion = await options.useArnRegion();
    const baseRegion = middleware_bucket_endpoint_1.getPseudoRegion(clientRegion);
    const { partition: clientPartition, signingRegion = baseRegion } = (await regionInfoProvider(baseRegion));
    const validatorOptions = {
        useDualstackEndpoint: options.useDualstackEndpoint,
        clientRegion,
        clientPartition,
        signingRegion,
        useArnRegion,
    };
    let arn;
    if (parameter === "Name") {
        arn = util_arn_parser_1.parse(input.Name);
        validateOutpostsArn(arn, validatorOptions);
        const { outpostId, accesspointName } = parseOutpostsAccessPointArnResource(arn.resource);
        input.Name = accesspointName;
        context[constants_1.CONTEXT_OUTPOST_ID] = outpostId;
    }
    else {
        arn = util_arn_parser_1.parse(input.Bucket);
        validateOutpostsArn(arn, validatorOptions);
        const { outpostId, bucketName } = parseOutpostBucketArnResource(arn.resource);
        input.Bucket = bucketName;
        context[constants_1.CONTEXT_OUTPOST_ID] = outpostId;
    }
    context[constants_1.CONTEXT_SIGNING_SERVICE] = arn.service; // s3-outposts
    context[constants_1.CONTEXT_SIGNING_REGION] = useArnRegion ? arn.region : signingRegion;
    if (!input.AccountId) {
        input.AccountId = arn.accountId;
    }
    else if (input.AccountId !== arn.accountId) {
        throw new Error(`AccountId is incompatible with account id inferred from ${parameter}`);
    }
    if (useArnRegion)
        context[constants_1.CONTEXT_ARN_REGION] = arn.region;
    return next(args);
};
exports.parseOutpostArnablesMiddleaware = parseOutpostArnablesMiddleaware;
exports.parseOutpostArnablesMiddleawareOptions = {
    step: "initialize",
    tags: ["CONVERT_ARN", "OUTPOST_BUCKET_ARN", "OUTPOST_ACCESS_POINT_ARN", "OUTPOST"],
    name: "parseOutpostArnablesMiddleaware",
};
/**
 * validate ARN with 's3-outposts' in the service section of the ARN:
 * ARN supplied to 'Name' parameter should comply template:
 *    arn:{partition}:s3-outposts:{region}:{accountId}:outpost/{outpostId}/accesspoint/{accesspointName}
 * ARN supplied to 'Bucket' parameter should comply template:
 *    arn:{partition}:s3-outposts:{region}:{accountId}:outpost/{outpostId}/bucket/{bucketName}
 */
const validateOutpostsArn = (arn, { clientRegion, signingRegion, clientPartition, useArnRegion, useDualstackEndpoint }) => {
    const { service, partition, accountId, region } = arn;
    middleware_bucket_endpoint_1.validateOutpostService(service);
    middleware_bucket_endpoint_1.validatePartition(partition, { clientPartition });
    middleware_bucket_endpoint_1.validateAccountId(accountId);
    middleware_bucket_endpoint_1.validateRegion(region, {
        useArnRegion,
        clientRegion,
        clientSigningRegion: signingRegion,
    });
    middleware_bucket_endpoint_1.validateNoDualstack(useDualstackEndpoint);
    if (!useArnRegion)
        middleware_bucket_endpoint_1.validateNoFIPS(clientRegion);
};
const parseOutpostsAccessPointArnResource = (resource) => {
    const { outpostId, accesspointName } = middleware_bucket_endpoint_1.getArnResources(resource);
    if (!outpostId) {
        throw new Error("ARN resource should begin with 'outpost'");
    }
    return {
        outpostId,
        accesspointName,
    };
};
const parseOutpostBucketArnResource = (resource) => {
    const delimiter = resource.includes(":") ? ":" : "/";
    const [resourceType, ...rest] = resource.split(delimiter);
    if (resourceType === "outpost") {
        // Parse outpost ARN
        if (!rest[0] || rest[1] !== "bucket" || !rest[2] || rest.length !== 3) {
            throw new Error(`Outpost Bucket ARN should have resource outpost${delimiter}{outpostId}${delimiter}bucket${delimiter}{bucketName}`);
        }
        const [outpostId, _, bucketName] = rest;
        return { outpostId, bucketName };
    }
    else {
        throw new Error(`ARN resource should begin with 'outpost${delimiter}'`);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2Utb3V0cG9zdC1hcm5hYmxlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wcm9jZXNzLWFybmFibGVzLXBsdWdpbi9wYXJzZS1vdXRwb3N0LWFybmFibGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG9GQVM2QztBQUU3Qyw4REFBMkY7QUFHM0YsNENBQXVIO0FBUXZIOzs7O0dBSUc7QUFDSSxNQUFNLCtCQUErQixHQUMxQyxDQUFDLE9BQWdDLEVBQTJDLEVBQUUsQ0FDOUUsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FDbEIsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFO0lBQ2IsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQztJQUV2QixNQUFNLFNBQVMsR0FDYixLQUFLLENBQUMsSUFBSSxJQUFJLDBCQUFXLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksMEJBQVcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ3BILElBQUksQ0FBQyxTQUFTO1FBQUUsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFbEMsTUFBTSxZQUFZLEdBQUcsTUFBTSxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDNUMsTUFBTSxFQUFFLGtCQUFrQixFQUFFLEdBQUcsT0FBTyxDQUFDO0lBQ3ZDLE1BQU0sWUFBWSxHQUFHLE1BQU0sT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2xELE1BQU0sVUFBVSxHQUFHLDRDQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDakQsTUFBTSxFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQUUsYUFBYSxHQUFHLFVBQVUsRUFBRSxHQUFHLENBQUMsTUFBTSxrQkFBa0Is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SyxDQUFDLDBDQUEwQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO0tBQ3pFO0FBQ0gsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgZ2V0QXJuUmVzb3VyY2VzIGFzIGdldFMzQWNjZXNzcG9pbnRBcm5SZXNvdXJjZXMsXG4gIGdldFBzZXVkb1JlZ2lvbixcbiAgdmFsaWRhdGVBY2NvdW50SWQsXG4gIHZhbGlkYXRlTm9EdWFsc3RhY2ssXG4gIHZhbGlkYXRlTm9GSVBTLFxuICB2YWxpZGF0ZU91dHBvc3RTZXJ2aWNlLFxuICB2YWxpZGF0ZVBhcnRpdGlvbixcbiAgdmFsaWRhdGVSZWdpb24sXG59IGZyb20gXCJAYXdzLXNkay9taWRkbGV3YXJlLWJ1Y2tldC1lbmRwb2ludFwiO1xuaW1wb3J0IHsgSW5pdGlhbGl6ZUhhbmRsZXJPcHRpb25zLCBJbml0aWFsaXplTWlkZGxld2FyZSB9IGZyb20gXCJAYXdzLXNkay90eXBlc1wiO1xuaW1wb3J0IHsgQVJOLCBwYXJzZSBhcyBwYXJzZUFybiwgdmFsaWRhdGUgYXMgdmFsaWRhdGVBcm4gfSBmcm9tIFwiQGF3cy1zZGsvdXRpbC1hcm4tcGFyc2VyXCI7XG5cbmltcG9ydCB7IFMzQ29udHJvbFJlc29sdmVkQ29uZmlnIH0gZnJvbSBcIi4uL2NvbmZpZ3VyYXRpb25zXCI7XG5pbXBvcnQgeyBDT05URVhUX0FSTl9SRUdJT04sIENPTlRFWFRfT1VUUE9TVF9JRCwgQ09OVEVYVF9TSUdOSU5HX1JFR0lPTiwgQ09OVEVYVF9TSUdOSU5HX1NFUlZJQ0UgfSBmcm9tIFwiLi4vY29uc3RhbnRzXCI7XG5cbnR5cGUgQXJuYWJsZUlucHV0ID0ge1xuICBOYW1lPzogc3RyaW5nO1xuICBCdWNrZXQ/OiBzdHJpbmc7XG4gIEFjY291bnRJZD86IHN0cmluZztcbn07XG5cbi8qKlxuICogVmFsaWRhdGUgaW5wdXQgYE5hbWVgIG9yIGBCdWNrZXRgIHBhcmFtZXRlciBpcyBhY2NlcHRhYmxlIEFSTiBmb3JtYXQuIElmIHNvLCBtb2RpZnkgdGhlIGlucHV0IEFSTiB0byBpbmZlcnJlZFxuICogcmVzb3VyY2UgaWRlbnRpZmllciwgbm90aWZ5IGxhdGVyIG1pZGRsZXdhcmUgdG8gcmVkaXJlY3QgcmVxdWVzdCB0byBPdXRwb3N0IGVuZHBvaW50LCBzaWduaW5nIHNlcnZpY2UgYW5kIHNpZ25pbmdcbiAqIHJlZ2lvbi5cbiAqL1xuZXhwb3J0IGNvbnN0IHBhcnNlT3V0cG9zdEFybmFibGVzTWlkZGxlYXdhcmUgPVxuICAob3B0aW9uczogUzNDb250cm9sUmVzb2x2ZWRDb25maWcpOiBJbml0aWFsaXplTWlkZGxld2FyZTxBcm5hYmxlSW5wdXQsIGFueT4gPT5cbiAgKG5leHQsIGNvbnRleHQpID0+XG4gIGFzeW5jIChhcmdzKSA9PiB7XG4gICAgY29uc3QgeyBpbnB1dCB9ID0gYXJncztcblxuICAgIGNvbnN0IHBhcmFtZXRlcjogXCJOYW1lXCIgfCBcIkJ1Y2tldFwiIHwgdW5kZWZpbmVkID1cbiAgICAgIGlucHV0Lk5hbWUgJiYgdmFsaWRhdGVBcm4oaW5wdXQuTmFtZSkgPyBcIk5hbWVcIiA6IGlucHV0LkJ1Y2tldCAmJiB2YWxpZGF0ZUFybihpbnB1dC5CdWNrZXQpID8gXCJCdWNrZXRcIiA6IHVuZGVmaW5lZDtcbiAgICBpZiAoIXBhcmFtZXRlcikgcmV0dXJuIG5leHQoYXJncyk7XG5cbiAgICBjb25zdCBjbGllbnRSZWdpb24gPSBhd2FpdCBvcHRpb25zLnJlZ2lvbigpO1xuICAgIGNvbnN0IHsgcmVnaW9uSW5mb1Byb3ZpZGVyIH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IHVzZUFyblJlZ2lvbiA9IGF3YWl0IG9wdGlvbnMudXNlQXJuUmVnaW9uKCk7XG4gICAgY29uc3QgYmFzZVJlZ2lvbiA9IGdldFBzZXVkb1JlZ2lvbihjbGllbnRSZWdpb24pO1xuICAgIGNvbnN0IHsgcGFydGl0aW9uOiBjbGllbnRQYXJ0aXRpb24sIHNpZ25pbmdSZWdpb24gPSBiYXNlUmVnaW9uIH0gPSAoYXdhaXQgcmVnaW9uSW5mb1Byb3ZpZGVyKGJhc2VSZWdpb24pKSE7XG4gICAgY29uc3QgdmFsaWRhdG9yT3B0aW9uczogVmFsaWRhdGVPdXRwb3N0c0Fybk9wdGlvbnMgPSB7XG4gICAgICB1c2VEdWFsc3RhY2tFbmRwb2ludDogb3B0aW9ucy51c2VEdWFsc3RhY2tFbmRwb2ludCxcbiAgICAgIGNsaWVudFJlZ2lvbixcbiAgICAgIGNsaWVudFBhcnRpdGlvbixcbiAgICAgIHNpZ25pbmdSZWdpb24sXG4gICAgICB1c2VBcm5SZWdpb24sXG4gICAgfTtcbiAgICBsZXQgYXJuOiBBUk47XG4gICAgaWYgKHBhcmFtZXRlciA9PT0gXCJOYW1lXCIpIHtcbiAgICAgIGFybiA9IHBhcnNlQXJuKGlucHV0Lk5hbWUhKTtcbiAgICAgIHZhbGlkYXRlT3V0cG9zdHNBcm4oYXJuLCB2YWxpZGF0b3JPcHRpb25zKTtcbiAgICAgIGNvbnN0IHsgb3V0cG9zdElkLCBhY2Nlc3Nwb2ludE5hbWUgfSA9IHBhcnNlT3V0cG9zdHNBY2Nlc3NQb2ludEFyblJlc291cmNlKGFybi5yZXNvdXJjZSk7XG4gICAgICBpbnB1dC5OYW1lID0gYWNjZXNzcG9pbnROYW1lO1xuICAgICAgY29udGV4dFtDT05URVhUX09VVFBPU1RfSURdID0gb3V0cG9zdElkO1xuICAgIH0gZWxzZSB7XG4gICAgICBhcm4gPSBwYXJzZUFybihpbnB1dC5CdWNrZXQhKTtcbiAgICAgIHZhbGlkYXRlT3V0cG9zdHNBcm4oYXJuLCB2YWxpZGF0b3JPcHRpb25zKTtcbiAgICAgIGNvbnN0IHsgb3V0cG9zdElkLCBidWNrZXROYW1lIH0gPSBwYXJzZU91dHBvc3RCdWNrZXRBcm5SZXNvdXJjZShhcm4ucmVzb3VyY2UpO1xuICAgICAgaW5wdXQuQnVja2V0ID0gYnVja2V0TmFtZTtcbiAgICAgIGNvbnRleHRbQ09OVEVYVF9PVVRQT1NUX0lEXSA9IG91dHBvc3RJZDtcbiAgICB9XG4gICAgY29udGV4dFtDT05URVhUX1NJR05JTkdfU0VSVklDRV0gPSBhcm4uc2VydmljZTsgLy8gczMtb3V0cG9zdHNcbiAgICBjb250ZXh0W0NPTlRFWFRfU0lHTklOR19SRUdJT05dID0gdXNlQXJuUmVnaW9uID8gYXJuLnJlZ2lvbiA6IHNpZ25pbmdSZWdpb247XG5cbiAgICBpZiAoIWlucHV0LkFjY291bnRJZCkge1xuICAgICAgaW5wdXQuQWNjb3VudElkID0gYXJuLmFjY291bnRJZDtcbiAgICB9IGVsc2UgaWYgKGlucHV0LkFjY291bnRJZCAhPT0gYXJuLmFjY291bnRJZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBBY2NvdW50SWQgaXMgaW5jb21wYXRpYmxlIHdpdGggYWNjb3VudCBpZCBpbmZlcnJlZCBmcm9tICR7cGFyYW1ldGVyfWApO1xuICAgIH1cblxuICAgIGlmICh1c2VBcm5SZWdpb24pIGNvbnRleHRbQ09OVEVYVF9BUk5fUkVHSU9OXSA9IGFybi5yZWdpb247XG5cbiAgICByZXR1cm4gbmV4dChhcmdzKTtcbiAgfTtcblxuZXhwb3J0IGNvbnN0IHBhcnNlT3V0cG9zdEFybmFibGVzTWlkZGxlYXdhcmVPcHRpb25zOiBJbml0aWFsaXplSGFuZGxlck9wdGlvbnMgPSB7XG4gIHN0ZXA6IFwiaW5pdGlhbGl6ZVwiLFxuICB0YWdzOiBbXCJDT05WRVJUX0FSTlwiLCBcIk9VVFBPU1RfQlVDS0VUX0FSTlwiLCBcIk9VVFBPU1RfQUNDRVNTX1BPSU5UX0FSTlwiLCBcIk9VVFBPU1RcIl0sXG4gIG5hbWU6IFwicGFyc2VPdXRwb3N0QXJuYWJsZXNNaWRkbGVhd2FyZVwiLFxufTtcblxudHlwZSBWYWxpZGF0ZU91dHBvc3RzQXJuT3B0aW9ucyA9IHtcbiAgY2xpZW50UmVnaW9uOiBzdHJpbmc7XG4gIHNpZ25pbmdSZWdpb246IHN0cmluZztcbiAgY2xpZW50UGFydGl0aW9uOiBzdHJpbmc7XG4gIHVzZUFyblJlZ2lvbjogYm9vbGVhbjtcbiAgdXNlRHVhbHN0YWNrRW5kcG9pbnQ6IGJvb2xlYW47XG59O1xuXG4vKipcbiAqIHZhbGlkYXRlIEFSTiB3aXRoICdzMy1vdXRwb3N0cycgaW4gdGhlIHNlcnZpY2Ugc2VjdGlvbiBvZiB0aGUgQVJOOlxuICogQVJOIHN1cHBsaWVkIHRvICdOYW1lJyBwYXJhbWV0ZXIgc2hvdWxkIGNvbXBseSB0ZW1wbGF0ZTpcbiAqICAgIGFybjp7cGFydGl0aW9ufTpzMy1vdXRwb3N0czp7cmVnaW9ufTp7YWNjb3VudElkfTpvdXRwb3N0L3tvdXRwb3N0SWR9L2FjY2Vzc3BvaW50L3thY2Nlc3Nwb2ludE5hbWV9XG4gKiBBUk4gc3VwcGxpZWQgdG8gJ0J1Y2tldCcgcGFyYW1ldGVyIHNob3VsZCBjb21wbHkgdGVtcGxhdGU6XG4gKiAgICBhcm46e3BhcnRpdGlvbn06czMtb3V0cG9zdHM6e3JlZ2lvbn06e2FjY291bnRJZH06b3V0cG9zdC97b3V0cG9zdElkfS9idWNrZXQve2J1Y2tldE5hbWV9XG4gKi9cbmNvbnN0IHZhbGlkYXRlT3V0cG9zdHNBcm4gPSAoXG4gIGFybjogQVJOLFxuICB7IGNsaWVudFJlZ2lvbiwgc2lnbmluZ1JlZ2lvbiwgY2xpZW50UGFydGl0aW9uLCB1c2VBcm5SZWdpb24sIHVzZUR1YWxzdGFja0VuZHBvaW50IH06IFZhbGlkYXRlT3V0cG9zdHNBcm5PcHRpb25zXG4pID0+IHtcbiAgY29uc3QgeyBzZXJ2aWNlLCBwYXJ0aXRpb24sIGFjY291bnRJZCwgcmVnaW9uIH0gPSBhcm47XG4gIHZhbGlkYXRlT3V0cG9zdFNlcnZpY2Uoc2VydmljZSk7XG4gIHZhbGlkYXRlUGFydGl0aW9uKHBhcnRpdGlvbiwgeyBjbGllbnRQYXJ0aXRpb24gfSk7XG4gIHZhbGlkYXRlQWNjb3VudElkKGFjY291bnRJZCk7XG4gIHZhbGlkYXRlUmVnaW9uKHJlZ2lvbiwge1xuICAgIHVzZUFyblJlZ2lvbixcbiAgICBjbGllbnRSZWdpb24sXG4gICAgY2xpZW50U2lnbmluZ1JlZ2lvbjogc2lnbmluZ1JlZ2lvbixcbiAgfSk7XG4gIHZhbGlkYXRlTm9EdWFsc3RhY2sodXNlRHVhbHN0YWNrRW5kcG9pbnQpO1xuICBpZiAoIXVzZUFyblJlZ2lvbikgdmFsaWRhdGVOb0ZJUFMoY2xpZW50UmVnaW9uKTtcbn07XG5cbmNvbnN0IHBhcnNlT3V0cG9zdHNBY2Nlc3NQb2ludEFyblJlc291cmNlID0gKFxuICByZXNvdXJjZTogc3RyaW5nXG4pOiB7XG4gIG91dHBvc3RJZDogc3RyaW5nO1xuICBhY2Nlc3Nwb2ludE5hbWU6IHN0cmluZztcbn0gPT4ge1xuICBjb25zdCB7IG91dHBvc3RJZCwgYWNjZXNzcG9pbnROYW1lIH0gPSBnZXRTM0FjY2Vzc3BvaW50QXJuUmVzb3VyY2VzKHJlc291cmNlKTtcbiAgaWYgKCFvdXRwb3N0SWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJBUk4gcmVzb3VyY2Ugc2hvdWxkIGJlZ2luIHdpdGggJ291dHBvc3QnXCIpO1xuICB9XG4gIHJldHVybiB7XG4gICAgb3V0cG9zdElkLFxuICAgIGFjY2Vzc3BvaW50TmFtZSxcbiAgfTtcbn07XG5cbmNvbnN0IHBhcnNlT3V0cG9zdEJ1Y2tldEFyblJlc291cmNlID0gKFxuICByZXNvdXJjZTogc3RyaW5nXG4pOiB7XG4gIG91dHBvc3RJZDogc3RyaW5nO1xuICBidWNrZXROYW1lOiBzdHJpbmc7XG59ID0+IHtcbiAgY29uc3QgZGVsaW1pdGVyID0gcmVzb3VyY2UuaW5jbHVkZXMoXCI6XCIpID8gXCI6XCIgOiBcIi9cIjtcbiAgY29uc3QgW3Jlc291cmNlVHlwZSwgLi4ucmVzdF0gPSByZXNvdXJjZS5zcGxpdChkZWxpbWl0ZXIpO1xuICBpZiAocmVzb3VyY2VUeXBlID09PSBcIm91dHBvc3RcIikge1xuICAgIC8vIFBhcnNlIG91dHBvc3QgQVJOXG4gICAgaWYgKCFyZXN0WzBdIHx8IHJlc3RbMV0gIT09IFwiYnVja2V0XCIgfHwgIXJlc3RbMl0gfHwgcmVzdC5sZW5ndGggIT09IDMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYE91dHBvc3QgQnVja2V0IEFSTiBzaG91bGQgaGF2ZSByZXNvdXJjZSBvdXRwb3N0JHtkZWxpbWl0ZXJ9e291dHBvc3RJZH0ke2RlbGltaXRlcn1idWNrZXQke2RlbGltaXRlcn17YnVja2V0TmFtZX1gXG4gICAgICApO1xuICAgIH1cbiAgICBjb25zdCBbb3V0cG9zdElkLCBfLCBidWNrZXROYW1lXSA9IHJlc3Q7XG4gICAgcmV0dXJuIHsgb3V0cG9zdElkLCBidWNrZXROYW1lIH07XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBBUk4gcmVzb3VyY2Ugc2hvdWxkIGJlZ2luIHdpdGggJ291dHBvc3Qke2RlbGltaXRlcn0nYCk7XG4gIH1cbn07XG4iXX0=