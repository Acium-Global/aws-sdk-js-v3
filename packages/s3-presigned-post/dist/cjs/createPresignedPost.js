"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createPresignedPost = void 0;
const signature_v4_1 = require("@aws-sdk/signature-v4");
const util_format_url_1 = require("@aws-sdk/util-format-url");
const util_hex_encoding_1 = require("@aws-sdk/util-hex-encoding");
const constants_1 = require("./constants");
/**
 * Builds the url and the form fields used for a presigned s3 post.
 */
const createPresignedPost = async (client, { Bucket, Key, Conditions = [], Fields = {}, Expires = 3600 }) => {
    const { systemClockOffset, base64Encoder, utf8Decoder, sha256 } = client.config;
    const now = new Date(Date.now() + systemClockOffset);
    // signingDate in format like '20201028T070711Z'.
    const signingDate = iso8601(now).replace(/[\-:]/g, "");
    const shortDate = signingDate.substr(0, 8);
    const clientRegion = await client.config.region();
    // Prepare credentials.
    const credentialScope = signature_v4_1.createScope(shortDate, clientRegion, "s3");
    const clientCredentials = await client.config.credentials();
    const credential = `${clientCredentials.accessKeyId}/${credentialScope}`;
    const fields = {
        ...Fields,
        bucket: Bucket,
        [constants_1.ALGORITHM_QUERY_PARAM]: constants_1.ALGORITHM_IDENTIFIER,
        [constants_1.CREDENTIAL_QUERY_PARAM]: credential,
        [constants_1.AMZ_DATE_QUERY_PARAM]: signingDate,
        ...(clientCredentials.sessionToken ? { [constants_1.TOKEN_QUERY_PARAM]: clientCredentials.sessionToken } : {}),
    };
    // Prepare policies.
    const expiration = new Date(now.valueOf() + Expires * 1000);
    const conditions = [
        ...Conditions,
        ...Object.entries(fields).map(([k, v]) => ({ [k]: v })),
        Key.endsWith("${filename}")
            ? ["starts-with", "$key", Key.substring(0, Key.lastIndexOf("${filename}"))]
            : { key: Key },
    ];
    const encodedPolicy = base64Encoder(utf8Decoder(JSON.stringify({
        expiration: iso8601(expiration),
        conditions,
    })));
    // Sign the request.
    const signingKey = await signature_v4_1.getSigningKey(sha256, clientCredentials, shortDate, clientRegion, "s3");
    const signature = await hmac(sha256, signingKey, encodedPolicy);
    const endpoint = await client.config.endpoint();
    if (!client.config.bucketEndpoint) {
        endpoint.path = `/${Bucket}`;
    }
    return {
        url: util_format_url_1.formatUrl(endpoint),
        fields: {
            ...fields,
            key: Key,
            Policy: encodedPolicy,
            [constants_1.SIGNATURE_QUERY_PARAM]: util_hex_encoding_1.toHex(signature),
        },
    };
};
exports.createPresignedPost = createPresignedPost;
const iso8601 = (date) => date.toISOString().replace(/\.\d{3}Z$/, "Z");
const hmac = (ctor, secret, data) => {
    const hash = new ctor(secret);
    hash.update(data);
    return hash.digest();
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlUHJlc2lnbmVkUG9zdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jcmVhdGVQcmVzaWduZWRQb3N0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHdEQUFtRTtBQUVuRSw4REFBcUQ7QUFDckQsa0VBQW1EO0FBRW5ELDJDQU9xQjtBQWtCckI7O0dBRUc7QUFDSSxNQUFNLG1CQUFtQixHQUFHLEtBQUssRUFDdEMsTUFBZ0IsRUFDaEIsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFVBQVUsR0FBRyxFQUFFLEVBQUUsTUFBTSxHQUFHLEVBQUUsRUFBRSxPQUFPLEdBQUcsSUFBSSxFQUF3QixFQUMzRCxFQUFFO0lBQzFCLE1BQU0sRUFBRSxpQkFBaUIsRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDaEYsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLGlCQUFpQixDQUFDLENBQUM7SUFFckQsaURBQWlEO0lBQ2pELE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZELE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzNDLE1BQU0sWUFBWSxHQUFHLE1BQU0sTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUVsRCx1QkFBdUI7SUFDdkIsTUFBTSxlQUFlLEdBQUcsMEJBQVcsQ0FBQyxTQUFTLEVBQUUsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ25FLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQzVELE1BQU0sVUFBVSxHQUFHLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxJQUFJLGVBQWUsRUFBRSxDQUFDO0lBRXpFLE1BQU0sTUFBTSxHQUFXO1FBQ3JCLEdBQUcsTUFBTTtRQUNULE1BQU0sRUFBRSxNQUFNO1FBQ2QsQ0FBQyxpQ0FBcUIsQ0FBQyxFQUFFLGdDQUFvQjtRQUM3QyxDQUFDLGtDQUFzQixDQUFDLEVBQUUsVUFBVTtRQUNwQyxDQUFDLGdDQUFvQixDQUFDLEVBQUUsV0FBVztRQUNuQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsNkJBQWlCLENBQUMsRUFBRSxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0tBQ25HLENBQUM7SUFFRixvQkFBb0I7SUFDcEIsTUFBTSxVQUFVLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQztJQUM1RCxNQUFNLFVBQVUsR0FBa0I7UUFDaEMsR0FBRyxVQUFVO1FBQ2IsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZELEdBQUcsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDO1lBQ3pCLENBQUMsQ0FBQyxDQUFDLGFBQWEsRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQzNFLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7S0FDakIsQ0FBQztJQUNGLE1BQU0sYUFBYSxHQUFHLGFBQWEsQ0FDakMsV0FBVyxDQUNULElBQUksQ0FBQyxTQUFTLENBQUM7UUFDYixVQUFVLEVBQUUsT0FBTyxDQUFDLFVBQVUsQ0FBQztRQUMvQixVQUFVO0tBQ1gsQ0FBQyxDQUNILENBQ0YsQ0FBQztJQUVGLG9CQUFvQjtJQUNwQixNQUFNLFVBQVUsR0FBRyxNQUFNLDRCQUFhLENBQUMsTUFBTSxFQUFFLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDakcsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQztJQUVoRSxNQUFNLFFBQVEsR0FBRyxNQUFNLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDaEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFO1FBQ2pDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztLQUM5QjtJQUVELE9BQU87UUFDTCxHQUFHLEVBQUUsMkJBQVMsQ0FBQyxRQUFRLENBQUM7UUFDeEIsTUFBTSxFQUFFO1lBQ04sR0FBRyxNQUFNO1lBQ1QsR0FBRyxFQUFFLEdBQUc7WUFDUixNQUFNLEVBQUUsYUFBYTtZQUNyQixDQUFDLGlDQUFxQixDQUFDLEVBQUUseUJBQUssQ0FBQyxTQUFTLENBQUM7U0FDMUM7S0FDRixDQUFDO0FBQ0osQ0FBQyxDQUFDO0FBOURXLFFBQUEsbUJBQW1CLHVCQThEOUI7QUFFRixNQUFNLE9BQU8sR0FBRyxDQUFDLElBQVUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFFN0UsTUFBTSxJQUFJLEdBQUcsQ0FBQyxJQUFxQixFQUFFLE1BQWtCLEVBQUUsSUFBZ0IsRUFBdUIsRUFBRTtJQUNoRyxNQUFNLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLE9BQU8sSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ3ZCLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFMzQ2xpZW50IH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1zM1wiO1xuaW1wb3J0IHsgY3JlYXRlU2NvcGUsIGdldFNpZ25pbmdLZXkgfSBmcm9tIFwiQGF3cy1zZGsvc2lnbmF0dXJlLXY0XCI7XG5pbXBvcnQgeyBIYXNoQ29uc3RydWN0b3IsIFNvdXJjZURhdGEgfSBmcm9tIFwiQGF3cy1zZGsvdHlwZXNcIjtcbmltcG9ydCB7IGZvcm1hdFVybCB9IGZyb20gXCJAYXdzLXNkay91dGlsLWZvcm1hdC11cmxcIjtcbmltcG9ydCB7IHRvSGV4IH0gZnJvbSBcIkBhd3Mtc2RrL3V0aWwtaGV4LWVuY29kaW5nXCI7XG5cbmltcG9ydCB7XG4gIEFMR09SSVRITV9JREVOVElGSUVSLFxuICBBTEdPUklUSE1fUVVFUllfUEFSQU0sXG4gIEFNWl9EQVRFX1FVRVJZX1BBUkFNLFxuICBDUkVERU5USUFMX1FVRVJZX1BBUkFNLFxuICBTSUdOQVRVUkVfUVVFUllfUEFSQU0sXG4gIFRPS0VOX1FVRVJZX1BBUkFNLFxufSBmcm9tIFwiLi9jb25zdGFudHNcIjtcbmltcG9ydCB7IENvbmRpdGlvbnMgYXMgUG9saWN5RW50cnkgfSBmcm9tIFwiLi90eXBlc1wiO1xuXG50eXBlIEZpZWxkcyA9IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJlc2lnbmVkUG9zdE9wdGlvbnMge1xuICBCdWNrZXQ6IHN0cmluZztcbiAgS2V5OiBzdHJpbmc7XG4gIENvbmRpdGlvbnM/OiBQb2xpY3lFbnRyeVtdO1xuICBGaWVsZHM/OiBGaWVsZHM7XG4gIEV4cGlyZXM/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJlc2lnbmVkUG9zdCB7XG4gIHVybDogc3RyaW5nO1xuICBmaWVsZHM6IEZpZWxkcztcbn1cblxuLyoqXG4gKiBCdWlsZHMgdGhlIHVybCBhbmQgdGhlIGZvcm0gZmllbGRzIHVzZWQgZm9yIGEgcHJlc2lnbmVkIHMzIHBvc3QuXG4gKi9cbmV4cG9ydCBjb25zdCBjcmVhdGVQcmVzaWduZWRQb3N0ID0gYXN5bmMgKFxuICBjbGllbnQ6IFMzQ2xpZW50LFxuICB7IEJ1Y2tldCwgS2V5LCBDb25kaXRpb25zID0gW10sIEZpZWxkcyA9IHt9LCBFeHBpcmVzID0gMzYwMCB9OiBQcmVzaWduZWRQb3N0T3B0aW9uc1xuKTogUHJvbWlzZTxQcmVzaWduZWRQb3N0PiA9PiB7XG4gIGNvbnN0IHsgc3lzdGVtQ2xvY2tPZmZzZXQsIGJhc2U2NEVuY29kZXIsIHV0ZjhEZWNvZGVyLCBzaGEyNTYgfSA9IGNsaWVudC5jb25maWc7XG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKERhdGUubm93KCkgKyBzeXN0ZW1DbG9ja09mZnNldCk7XG5cbiAgLy8gc2lnbmluZ0RhdGUgaW4gZm9ybWF0IGxpa2UgJzIwMjAxMDI4VDA3MDcxMVonLlxuICBjb25zdCBzaWduaW5nRGF0ZSA9IGlzbzg2MDEobm93KS5yZXBsYWNlKC9bXFwtOl0vZywgXCJcIik7XG4gIGNvbnN0IHNob3J0RGF0ZSA9IHNpZ25pbmdEYXRlLnN1YnN0cigwLCA4KTtcbiAgY29uc3QgY2xpZW50UmVnaW9uID0gYXdhaXQgY2xpZW50LmNvbmZpZy5yZWdpb24oKTtcblxuICAvLyBQcmVwYXJlIGNyZWRlbnRpYWxzLlxuICBjb25zdCBjcmVkZW50aWFsU2NvcGUgPSBjcmVhdGVTY29wZShzaG9ydERhdGUsIGNsaWVudFJlZ2lvbiwgXCJzM1wiKTtcbiAgY29uc3QgY2xpZW50Q3JlZGVudGlhbHMgPSBhd2FpdCBjbGllbnQuY29uZmlnLmNyZWRlbnRpYWxzKCk7XG4gIGNvbnN0IGNyZWRlbnRpYWwgPSBgJHtjbGllbnRDcmVkZW50aWFscy5hY2Nlc3NLZXlJZH0vJHtjcmVkZW50aWFsU2NvcGV9YDtcblxuICBjb25zdCBmaWVsZHM6IEZpZWxkcyA9IHtcbiAgICAuLi5GaWVsZHMsXG4gICAgYnVja2V0OiBCdWNrZXQsXG4gICAgW0FMR09SSVRITV9RVUVSWV9QQVJBTV06IEFMR09SSVRITV9JREVOVElGSUVSLFxuICAgIFtDUkVERU5USUFMX1FVRVJZX1BBUkFNXTogY3JlZGVudGlhbCxcbiAgICBbQU1aX0RBVEVfUVVFUllfUEFSQU1dOiBzaWduaW5nRGF0ZSxcbiAgICAuLi4oY2xpZW50Q3JlZGVudGlhbHMuc2Vzc2lvblRva2VuID8geyBbVE9LRU5fUVVFUllfUEFSQU1dOiBjbGllbnRDcmVkZW50aWFscy5zZXNzaW9uVG9rZW4gfSA6IHt9KSxcbiAgfTtcblxuICAvLyBQcmVwYXJlIHBvbGljaWVzLlxuICBjb25zdCBleHBpcmF0aW9uID0gbmV3IERhdGUobm93LnZhbHVlT2YoKSArIEV4cGlyZXMgKiAxMDAwKTtcbiAgY29uc3QgY29uZGl0aW9uczogUG9saWN5RW50cnlbXSA9IFtcbiAgICAuLi5Db25kaXRpb25zLFxuICAgIC4uLk9iamVjdC5lbnRyaWVzKGZpZWxkcykubWFwKChbaywgdl0pID0+ICh7IFtrXTogdiB9KSksXG4gICAgS2V5LmVuZHNXaXRoKFwiJHtmaWxlbmFtZX1cIilcbiAgICAgID8gW1wic3RhcnRzLXdpdGhcIiwgXCIka2V5XCIsIEtleS5zdWJzdHJpbmcoMCwgS2V5Lmxhc3RJbmRleE9mKFwiJHtmaWxlbmFtZX1cIikpXVxuICAgICAgOiB7IGtleTogS2V5IH0sXG4gIF07XG4gIGNvbnN0IGVuY29kZWRQb2xpY3kgPSBiYXNlNjRFbmNvZGVyKFxuICAgIHV0ZjhEZWNvZGVyKFxuICAgICAgSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBleHBpcmF0aW9uOiBpc284NjAxKGV4cGlyYXRpb24pLFxuICAgICAgICBjb25kaXRpb25zLFxuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgLy8gU2lnbiB0aGUgcmVxdWVzdC5cbiAgY29uc3Qgc2lnbmluZ0tleSA9IGF3YWl0IGdldFNpZ25pbmdLZXkoc2hhMjU2LCBjbGllbnRDcmVkZW50aWFscywgc2hvcnREYXRlLCBjbGllbnRSZWdpb24sIFwiczNcIik7XG4gIGNvbnN0IHNpZ25hdHVyZSA9IGF3YWl0IGhtYWMoc2hhMjU2LCBzaWduaW5nS2V5LCBlbmNvZGVkUG9saWN5KTtcblxuICBjb25zdCBlbmRwb2ludCA9IGF3YWl0IGNsaWVudC5jb25maWcuZW5kcG9pbnQoKTtcbiAgaWYgKCFjbGllbnQuY29uZmlnLmJ1Y2tldEVuZHBvaW50KSB7XG4gICAgZW5kcG9pbnQucGF0aCA9IGAvJHtCdWNrZXR9YDtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgdXJsOiBmb3JtYXRVcmwoZW5kcG9pbnQpLFxuICAgIGZpZWxkczoge1xuICAgICAgLi4uZmllbGRzLFxuICAgICAga2V5OiBLZXksXG4gICAgICBQb2xpY3k6IGVuY29kZWRQb2xpY3ksXG4gICAgICBbU0lHTkFUVVJFX1FVRVJZX1BBUkFNXTogdG9IZXgoc2lnbmF0dXJlKSxcbiAgICB9LFxuICB9O1xufTtcblxuY29uc3QgaXNvODYwMSA9IChkYXRlOiBEYXRlKSA9PiBkYXRlLnRvSVNPU3RyaW5nKCkucmVwbGFjZSgvXFwuXFxkezN9WiQvLCBcIlpcIik7XG5cbmNvbnN0IGhtYWMgPSAoY3RvcjogSGFzaENvbnN0cnVjdG9yLCBzZWNyZXQ6IFNvdXJjZURhdGEsIGRhdGE6IFNvdXJjZURhdGEpOiBQcm9taXNlPFVpbnQ4QXJyYXk+ID0+IHtcbiAgY29uc3QgaGFzaCA9IG5ldyBjdG9yKHNlY3JldCk7XG4gIGhhc2gudXBkYXRlKGRhdGEpO1xuICByZXR1cm4gaGFzaC5kaWdlc3QoKTtcbn07XG4iXX0=