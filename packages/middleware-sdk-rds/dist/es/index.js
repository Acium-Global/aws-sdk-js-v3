import { __assign, __awaiter, __generator, __values } from "tslib";
import { HttpRequest } from "@aws-sdk/protocol-http";
import { SignatureV4 } from "@aws-sdk/signature-v4";
import { formatUrl } from "@aws-sdk/util-format-url";
import { escapeUri } from "@aws-sdk/util-uri-escape";
var regARN = /arn:[\w+=/,.@-]+:[\w+=/,.@-]+:([\w+=/,.@-]*)?:[0-9]+:[\w+=/,.@-]+(:[\w+=/,.@-]+)?(:[\w+=/,.@-]+)?/;
var sourceIds = [
    "SourceDBSnapshotIdentifier",
    "SourceDBInstanceIdentifier",
    "ReplicationSourceIdentifier",
    "SourceDBClusterSnapshotIdentifier",
];
var sourceIdToCommandKeyMap = {
    SourceDBSnapshotIdentifier: "CopyDBSnapshot",
    SourceDBInstanceIdentifier: "CreateDBInstanceReadReplica",
    ReplicationSourceIdentifier: "CreateDBCluster",
    SourceDBClusterSnapshotIdentifier: "CopyDBClusterSnapshot",
};
var version = "2014-10-31";
/**
 * Config of the middleware to automatically add presigned URL to request.
 * The presigned URL is generated by sigV4
 */
export function crossRegionPresignedUrlMiddleware(options) {
    var _this = this;
    return function (next) {
        return function (args) { return __awaiter(_this, void 0, void 0, function () {
            var input, region, command, sourceId, sourceIds_1, sourceIds_1_1, id, sourceRegion, resolvedEndpoint, request, signer, presignedRequest;
            var e_1, _a, _b;
            return __generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        input = args.input;
                        return [4 /*yield*/, options.region()];
                    case 1:
                        region = _c.sent();
                        try {
                            for (sourceIds_1 = __values(sourceIds), sourceIds_1_1 = sourceIds_1.next(); !sourceIds_1_1.done; sourceIds_1_1 = sourceIds_1.next()) {
                                id = sourceIds_1_1.value;
                                if (input.hasOwnProperty(id)) {
                                    sourceId = id;
                                    command = sourceIdToCommandKeyMap[id];
                                }
                            }
                        }
                        catch (e_1_1) { e_1 = { error: e_1_1 }; }
                        finally {
                            try {
                                if (sourceIds_1_1 && !sourceIds_1_1.done && (_a = sourceIds_1.return)) _a.call(sourceIds_1);
                            }
                            finally { if (e_1) throw e_1.error; }
                        }
                        if (!sourceId) {
                            throw new Error("Source identifier key not set");
                        }
                        if (!(!input.PreSignedUrl && isARN(input[sourceId]) && region !== getEndpointFromARN(input[sourceId]))) return [3 /*break*/, 4];
                        sourceRegion = getEndpointFromARN(input[sourceId]);
                        return [4 /*yield*/, options.endpoint()];
                    case 2:
                        resolvedEndpoint = _c.sent();
                        resolvedEndpoint.hostname = "rds." + sourceRegion + ".amazonaws.com";
                        request = new HttpRequest(__assign(__assign({}, resolvedEndpoint), { protocol: "https", headers: {
                                host: resolvedEndpoint.hostname,
                            }, query: (_b = {
                                    Action: command,
                                    Version: version,
                                    KmsKeyId: input.KmsKeyId,
                                    DestinationRegion: region
                                },
                                _b[sourceId] = input[sourceId],
                                _b) }));
                        signer = new SignatureV4({
                            credentials: options.credentials,
                            region: sourceRegion,
                            service: "rds",
                            sha256: options.sha256,
                            uriEscapePath: options.signingEscapePath,
                        });
                        return [4 /*yield*/, signer.presign(request, {
                                expiresIn: 3600,
                            })];
                    case 3:
                        presignedRequest = _c.sent();
                        args = __assign(__assign({}, args), { input: __assign(__assign({}, args.input), { PreSignedUrl: escapeUri(formatUrl(presignedRequest)) }) });
                        _c.label = 4;
                    case 4: return [2 /*return*/, next(args)];
                }
            });
        }); };
    };
}
export var crossRegionPresignedUrlMiddlewareOptions = {
    step: "initialize",
    tags: ["CROSS_REGION_PRESIGNED_URL"],
    name: "crossRegionPresignedUrlMiddleware",
    override: true,
};
export var getCrossRegionPresignedUrlPlugin = function (config) { return ({
    applyToStack: function (clientStack) {
        clientStack.add(crossRegionPresignedUrlMiddleware(config), crossRegionPresignedUrlMiddlewareOptions);
    },
}); };
function isARN(id) {
    if (!id)
        return false;
    return regARN.test(id);
}
function getEndpointFromARN(arn) {
    var arnArr = arn.split(":");
    if (arnArr.length < 4) {
        throw new Error("Cannot infer endpoint from '" + arn + "'");
    }
    return arnArr[3];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFjcEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVyRCxJQUFNLE1BQU0sR0FBRyxtR0FBbUcsQ0FBQztBQUVuSCxJQUFNLFNBQVMsR0FBYTtJQUMxQiw0QkFBNEI7SUFDNUIsNEJBQTRCO0lBQzVCLDZCQUE2QjtJQUM3QixtQ0FBbUM7Q0FDcEMsQ0FBQztBQUVGLElBQU0sdUJBQXVCLEdBQThCO0lBQ3pELDBCQUEwQixFQUFFLGdCQUFnQjtJQUM1QywwQkFBMEIsRUFBRSw2QkFBNkI7SUFDekQsMkJBQTJCLEVBQUUsaUJBQWlCO0lBQzlDLGlDQUFpQyxFQUFFLHVCQUF1QjtDQUMzRCxDQUFDO0FBRUYsSUFBTSxPQUFPLEdBQUcsWUFBWSxDQUFDO0FBVTdCOzs7R0FHRztBQUVILE1BQU0sVUFBVSxpQ0FBaUMsQ0FBQyxPQUEyQjtJQUE3RSxpQkFxREM7SUFwREMsT0FBTyxVQUFnQyxJQUFvQztRQUN6RSxPQUFBLFVBQU8sSUFBcUM7Ozs7Ozt3QkFDbEMsS0FBSyxHQUFLLElBQUksTUFBVCxDQUFVO3dCQUNSLHFCQUFNLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBQTs7d0JBQS9CLE1BQU0sR0FBRyxTQUFzQjs7NEJBRXJDLEtBQWlCLGNBQUEsU0FBQSxTQUFTLENBQUEsK0ZBQUU7Z0NBQWpCLEVBQUU7Z0NBQ1gsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxFQUFFO29DQUM1QixRQUFRLEdBQUcsRUFBRSxDQUFDO29DQUNkLE9BQU8sR0FBRyx1QkFBdUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQ0FDdkM7NkJBQ0Y7Ozs7Ozs7Ozt3QkFDRCxJQUFJLENBQUMsUUFBUSxFQUFFOzRCQUNiLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQzt5QkFDbEQ7NkJBQ0csQ0FBQSxDQUFDLEtBQUssQ0FBQyxZQUFZLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLE1BQU0sS0FBSyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQSxFQUEvRix3QkFBK0Y7d0JBQzNGLFlBQVksR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQzt3QkFDaEMscUJBQU0sT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFBOzt3QkFBM0MsZ0JBQWdCLEdBQUcsU0FBd0I7d0JBQ2pELGdCQUFnQixDQUFDLFFBQVEsR0FBRyxTQUFPLFlBQVksbUJBQWdCLENBQUM7d0JBQzFELE9BQU8sR0FBRyxJQUFJLFdBQVcsdUJBQzFCLGdCQUFnQixLQUNuQixRQUFRLEVBQUUsT0FBTyxFQUNqQixPQUFPLEVBQUU7Z0NBQ1AsSUFBSSxFQUFFLGdCQUFnQixDQUFDLFFBQVE7NkJBQ2hDLEVBQ0QsS0FBSztvQ0FDSCxNQUFNLEVBQUUsT0FBTztvQ0FDZixPQUFPLEVBQUUsT0FBTztvQ0FDaEIsUUFBUSxFQUFFLEtBQUssQ0FBQyxRQUFRO29DQUN4QixpQkFBaUIsRUFBRSxNQUFNOztnQ0FDekIsR0FBQyxRQUFRLElBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQzt1Q0FFN0IsQ0FBQzt3QkFDRyxNQUFNLEdBQUcsSUFBSSxXQUFXLENBQUM7NEJBQzdCLFdBQVcsRUFBRSxPQUFPLENBQUMsV0FBVzs0QkFDaEMsTUFBTSxFQUFFLFlBQVk7NEJBQ3BCLE9BQU8sRUFBRSxLQUFLOzRCQUNkLE1BQU0sRUFBRSxPQUFPLENBQUMsTUFBTTs0QkFDdEIsYUFBYSxFQUFFLE9BQU8sQ0FBQyxpQkFBaUI7eUJBQ3pDLENBQUMsQ0FBQzt3QkFDc0IscUJBQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7Z0NBQ3JELFNBQVMsRUFBRSxJQUFJOzZCQUNoQixDQUFDLEVBQUE7O3dCQUZJLGdCQUFnQixHQUFHLFNBRXZCO3dCQUNGLElBQUkseUJBQ0MsSUFBSSxLQUNQLEtBQUssd0JBQ0EsSUFBSSxDQUFDLEtBQUssS0FDYixZQUFZLEVBQUUsU0FBUyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE1BRXZELENBQUM7OzRCQUVKLHNCQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBQzs7O2FBQ25CO0lBbERELENBa0RDLENBQUM7QUFDTixDQUFDO0FBRUQsTUFBTSxDQUFDLElBQU0sd0NBQXdDLEdBQTZCO0lBQ2hGLElBQUksRUFBRSxZQUFZO0lBQ2xCLElBQUksRUFBRSxDQUFDLDRCQUE0QixDQUFDO0lBQ3BDLElBQUksRUFBRSxtQ0FBbUM7SUFDekMsUUFBUSxFQUFFLElBQUk7Q0FDZixDQUFDO0FBRUYsTUFBTSxDQUFDLElBQU0sZ0NBQWdDLEdBQUcsVUFBQyxNQUEwQixJQUEwQixPQUFBLENBQUM7SUFDcEcsWUFBWSxFQUFFLFVBQUMsV0FBVztRQUN4QixXQUFXLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLHdDQUF3QyxDQUFDLENBQUM7SUFDdkcsQ0FBQztDQUNGLENBQUMsRUFKbUcsQ0FJbkcsQ0FBQztBQUVILFNBQVMsS0FBSyxDQUFDLEVBQXNCO0lBQ25DLElBQUksQ0FBQyxFQUFFO1FBQUUsT0FBTyxLQUFLLENBQUM7SUFDdEIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pCLENBQUM7QUFFRCxTQUFTLGtCQUFrQixDQUFDLEdBQVc7SUFDckMsSUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM5QixJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1FBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQStCLEdBQUcsTUFBRyxDQUFDLENBQUM7S0FDeEQ7SUFDRCxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cFJlcXVlc3QgfSBmcm9tIFwiQGF3cy1zZGsvcHJvdG9jb2wtaHR0cFwiO1xuaW1wb3J0IHsgU2lnbmF0dXJlVjQgfSBmcm9tIFwiQGF3cy1zZGsvc2lnbmF0dXJlLXY0XCI7XG5pbXBvcnQge1xuICBDcmVkZW50aWFscyxcbiAgRW5kcG9pbnQsXG4gIEhhc2hDb25zdHJ1Y3RvcixcbiAgSW5pdGlhbGl6ZUhhbmRsZXIsXG4gIEluaXRpYWxpemVIYW5kbGVyQXJndW1lbnRzLFxuICBJbml0aWFsaXplSGFuZGxlck9wdGlvbnMsXG4gIEluaXRpYWxpemVIYW5kbGVyT3V0cHV0LFxuICBJbml0aWFsaXplTWlkZGxld2FyZSxcbiAgTWV0YWRhdGFCZWFyZXIsXG4gIFBsdWdnYWJsZSxcbiAgUHJvdmlkZXIsXG59IGZyb20gXCJAYXdzLXNkay90eXBlc1wiO1xuaW1wb3J0IHsgZm9ybWF0VXJsIH0gZnJvbSBcIkBhd3Mtc2RrL3V0aWwtZm9ybWF0LXVybFwiO1xuaW1wb3J0IHsgZXNjYXBlVXJpIH0gZnJvbSBcIkBhd3Mtc2RrL3V0aWwtdXJpLWVzY2FwZVwiO1xuXG5jb25zdCByZWdBUk4gPSAvYXJuOltcXHcrPS8sLkAtXSs6W1xcdys9LywuQC1dKzooW1xcdys9LywuQC1dKik/OlswLTldKzpbXFx3Kz0vLC5ALV0rKDpbXFx3Kz0vLC5ALV0rKT8oOltcXHcrPS8sLkAtXSspPy87XG5cbmNvbnN0IHNvdXJjZUlkczogc3RyaW5nW10gPSBbXG4gIFwiU291cmNlREJTbmFwc2hvdElkZW50aWZpZXJcIixcbiAgXCJTb3VyY2VEQkluc3RhbmNlSWRlbnRpZmllclwiLFxuICBcIlJlcGxpY2F0aW9uU291cmNlSWRlbnRpZmllclwiLFxuICBcIlNvdXJjZURCQ2x1c3RlclNuYXBzaG90SWRlbnRpZmllclwiLFxuXTtcblxuY29uc3Qgc291cmNlSWRUb0NvbW1hbmRLZXlNYXA6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7XG4gIFNvdXJjZURCU25hcHNob3RJZGVudGlmaWVyOiBcIkNvcHlEQlNuYXBzaG90XCIsXG4gIFNvdXJjZURCSW5zdGFuY2VJZGVudGlmaWVyOiBcIkNyZWF0ZURCSW5zdGFuY2VSZWFkUmVwbGljYVwiLFxuICBSZXBsaWNhdGlvblNvdXJjZUlkZW50aWZpZXI6IFwiQ3JlYXRlREJDbHVzdGVyXCIsXG4gIFNvdXJjZURCQ2x1c3RlclNuYXBzaG90SWRlbnRpZmllcjogXCJDb3B5REJDbHVzdGVyU25hcHNob3RcIixcbn07XG5cbmNvbnN0IHZlcnNpb24gPSBcIjIwMTQtMTAtMzFcIjtcblxuaW50ZXJmYWNlIFByZXZpb3VzbHlSZXNvbHZlZCB7XG4gIGNyZWRlbnRpYWxzOiBQcm92aWRlcjxDcmVkZW50aWFscz47XG4gIGVuZHBvaW50OiBQcm92aWRlcjxFbmRwb2ludD47XG4gIHJlZ2lvbjogUHJvdmlkZXI8c3RyaW5nPjtcbiAgc2hhMjU2OiBIYXNoQ29uc3RydWN0b3I7XG4gIHNpZ25pbmdFc2NhcGVQYXRoOiBib29sZWFuO1xufVxuXG4vKipcbiAqIENvbmZpZyBvZiB0aGUgbWlkZGxld2FyZSB0byBhdXRvbWF0aWNhbGx5IGFkZCBwcmVzaWduZWQgVVJMIHRvIHJlcXVlc3QuXG4gKiBUaGUgcHJlc2lnbmVkIFVSTCBpcyBnZW5lcmF0ZWQgYnkgc2lnVjRcbiAqL1xuXG5leHBvcnQgZnVuY3Rpb24gY3Jvc3NSZWdpb25QcmVzaWduZWRVcmxNaWRkbGV3YXJlKG9wdGlvbnM6IFByZXZpb3VzbHlSZXNvbHZlZCk6IEluaXRpYWxpemVNaWRkbGV3YXJlPGFueSwgYW55PiB7XG4gIHJldHVybiA8T3V0cHV0IGV4dGVuZHMgTWV0YWRhdGFCZWFyZXI+KG5leHQ6IEluaXRpYWxpemVIYW5kbGVyPGFueSwgT3V0cHV0Pik6IEluaXRpYWxpemVIYW5kbGVyPGFueSwgT3V0cHV0PiA9PlxuICAgIGFzeW5jIChhcmdzOiBJbml0aWFsaXplSGFuZGxlckFyZ3VtZW50czxhbnk+KTogUHJvbWlzZTxJbml0aWFsaXplSGFuZGxlck91dHB1dDxPdXRwdXQ+PiA9PiB7XG4gICAgICBjb25zdCB7IGlucHV0IH0gPSBhcmdzO1xuICAgICAgY29uc3QgcmVnaW9uID0gYXdhaXQgb3B0aW9ucy5yZWdpb24oKTtcbiAgICAgIGxldCBjb21tYW5kLCBzb3VyY2VJZDtcbiAgICAgIGZvciAoY29uc3QgaWQgb2Ygc291cmNlSWRzKSB7XG4gICAgICAgIGlmIChpbnB1dC5oYXNPd25Qcm9wZXJ0eShpZCkpIHtcbiAgICAgICAgICBzb3VyY2VJZCA9IGlkO1xuICAgICAgICAgIGNvbW1hbmQgPSBzb3VyY2VJZFRvQ29tbWFuZEtleU1hcFtpZF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmICghc291cmNlSWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU291cmNlIGlkZW50aWZpZXIga2V5IG5vdCBzZXRcIik7XG4gICAgICB9XG4gICAgICBpZiAoIWlucHV0LlByZVNpZ25lZFVybCAmJiBpc0FSTihpbnB1dFtzb3VyY2VJZF0pICYmIHJlZ2lvbiAhPT0gZ2V0RW5kcG9pbnRGcm9tQVJOKGlucHV0W3NvdXJjZUlkXSkpIHtcbiAgICAgICAgY29uc3Qgc291cmNlUmVnaW9uID0gZ2V0RW5kcG9pbnRGcm9tQVJOKGlucHV0W3NvdXJjZUlkXSk7XG4gICAgICAgIGNvbnN0IHJlc29sdmVkRW5kcG9pbnQgPSBhd2FpdCBvcHRpb25zLmVuZHBvaW50KCk7XG4gICAgICAgIHJlc29sdmVkRW5kcG9pbnQuaG9zdG5hbWUgPSBgcmRzLiR7c291cmNlUmVnaW9ufS5hbWF6b25hd3MuY29tYDtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IG5ldyBIdHRwUmVxdWVzdCh7XG4gICAgICAgICAgLi4ucmVzb2x2ZWRFbmRwb2ludCxcbiAgICAgICAgICBwcm90b2NvbDogXCJodHRwc1wiLFxuICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgIGhvc3Q6IHJlc29sdmVkRW5kcG9pbnQuaG9zdG5hbWUsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBxdWVyeToge1xuICAgICAgICAgICAgQWN0aW9uOiBjb21tYW5kLFxuICAgICAgICAgICAgVmVyc2lvbjogdmVyc2lvbixcbiAgICAgICAgICAgIEttc0tleUlkOiBpbnB1dC5LbXNLZXlJZCxcbiAgICAgICAgICAgIERlc3RpbmF0aW9uUmVnaW9uOiByZWdpb24sXG4gICAgICAgICAgICBbc291cmNlSWRdOiBpbnB1dFtzb3VyY2VJZF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHNpZ25lciA9IG5ldyBTaWduYXR1cmVWNCh7XG4gICAgICAgICAgY3JlZGVudGlhbHM6IG9wdGlvbnMuY3JlZGVudGlhbHMsXG4gICAgICAgICAgcmVnaW9uOiBzb3VyY2VSZWdpb24sXG4gICAgICAgICAgc2VydmljZTogXCJyZHNcIixcbiAgICAgICAgICBzaGEyNTY6IG9wdGlvbnMuc2hhMjU2LFxuICAgICAgICAgIHVyaUVzY2FwZVBhdGg6IG9wdGlvbnMuc2lnbmluZ0VzY2FwZVBhdGgsXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCBwcmVzaWduZWRSZXF1ZXN0ID0gYXdhaXQgc2lnbmVyLnByZXNpZ24ocmVxdWVzdCwge1xuICAgICAgICAgIGV4cGlyZXNJbjogMzYwMCxcbiAgICAgICAgfSk7XG4gICAgICAgIGFyZ3MgPSB7XG4gICAgICAgICAgLi4uYXJncyxcbiAgICAgICAgICBpbnB1dDoge1xuICAgICAgICAgICAgLi4uYXJncy5pbnB1dCxcbiAgICAgICAgICAgIFByZVNpZ25lZFVybDogZXNjYXBlVXJpKGZvcm1hdFVybChwcmVzaWduZWRSZXF1ZXN0KSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBuZXh0KGFyZ3MpO1xuICAgIH07XG59XG5cbmV4cG9ydCBjb25zdCBjcm9zc1JlZ2lvblByZXNpZ25lZFVybE1pZGRsZXdhcmVPcHRpb25zOiBJbml0aWFsaXplSGFuZGxlck9wdGlvbnMgPSB7XG4gIHN0ZXA6IFwiaW5pdGlhbGl6ZVwiLFxuICB0YWdzOiBbXCJDUk9TU19SRUdJT05fUFJFU0lHTkVEX1VSTFwiXSxcbiAgbmFtZTogXCJjcm9zc1JlZ2lvblByZXNpZ25lZFVybE1pZGRsZXdhcmVcIixcbiAgb3ZlcnJpZGU6IHRydWUsXG59O1xuXG5leHBvcnQgY29uc3QgZ2V0Q3Jvc3NSZWdpb25QcmVzaWduZWRVcmxQbHVnaW4gPSAoY29uZmlnOiBQcmV2aW91c2x5UmVzb2x2ZWQpOiBQbHVnZ2FibGU8YW55LCBhbnk+ID0+ICh7XG4gIGFwcGx5VG9TdGFjazogKGNsaWVudFN0YWNrKSA9PiB7XG4gICAgY2xpZW50U3RhY2suYWRkKGNyb3NzUmVnaW9uUHJlc2lnbmVkVXJsTWlkZGxld2FyZShjb25maWcpLCBjcm9zc1JlZ2lvblByZXNpZ25lZFVybE1pZGRsZXdhcmVPcHRpb25zKTtcbiAgfSxcbn0pO1xuXG5mdW5jdGlvbiBpc0FSTihpZDogc3RyaW5nIHwgdW5kZWZpbmVkKTogYm9vbGVhbiB7XG4gIGlmICghaWQpIHJldHVybiBmYWxzZTtcbiAgcmV0dXJuIHJlZ0FSTi50ZXN0KGlkKTtcbn1cblxuZnVuY3Rpb24gZ2V0RW5kcG9pbnRGcm9tQVJOKGFybjogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgYXJuQXJyID0gYXJuLnNwbGl0KFwiOlwiKTtcbiAgaWYgKGFybkFyci5sZW5ndGggPCA0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgaW5mZXIgZW5kcG9pbnQgZnJvbSAnJHthcm59J2ApO1xuICB9XG4gIHJldHVybiBhcm5BcnJbM107XG59XG4iXX0=